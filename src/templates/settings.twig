{% import '_includes/forms.twig' as forms %}

{% if not sections|length %}
    <p class="light">No Structure sections found. This plugin only works with Structure sections.</p>
{% else %}
    <p class="light" style="margin-bottom: 24px;">
        Configure parent-child relationships between Entry Types. New entries will automatically nest under the configured parent.
    </p>

    <style>
        .accordion-section { border: 1px solid #e3e5e8; border-radius: 4px; margin-bottom: 8px; background: #fff; }
        .accordion-header { display: flex; align-items: center; padding: 12px 16px; cursor: pointer; user-select: none; }
        .accordion-header:hover { background: #f8f9fa; }
        .accordion-toggle { width: 20px; color: #8f98a3; transition: transform 0.2s; }
        .accordion-section.open .accordion-toggle { transform: rotate(90deg); }
        .accordion-title { font-weight: 600; flex: 1; }
        .accordion-meta { color: #8f98a3; font-size: 12px; }
        .accordion-body { display: none; padding: 0 16px 16px; }
        .accordion-section.open .accordion-body { display: block; }
        .hierarchy-badge { display: inline-block; background: #e3f2e6; color: #287d3c; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 8px; }
    </style>

    {% for section in sections %}
        {% set entryTypes = section.getEntryTypes() %}
        {% set sectionConfig = settings.sectionConfig[section.uid] ?? {} %}
        {% set typeHierarchy = sectionConfig.typeHierarchy ?? {} %}
        {% set typeOrder = sectionConfig.typeOrder ?? [] %}
        {% set configuredCount = typeHierarchy|filter(c => c.parentTypeUid ?? false)|length %}

        {# Sort entry types by saved order #}
        {% set orderedTypes = [] %}
        {% for uid in typeOrder %}
            {% set matchingType = entryTypes|filter(t => t.uid == uid)|first %}
            {% if matchingType %}
                {% set orderedTypes = orderedTypes|merge([matchingType]) %}
            {% endif %}
        {% endfor %}
        {% for type in entryTypes|filter(t => t.uid not in typeOrder) %}
            {% set orderedTypes = orderedTypes|merge([type]) %}
        {% endfor %}

        <div class="accordion-section section-config {{ loop.first ? 'open' : '' }}" data-section-uid="{{ section.uid }}">
            <div class="accordion-header">
                <span class="accordion-toggle">▶</span>
                <span class="accordion-title">{{ section.name }}</span>
                {% if configuredCount > 0 %}
                    <span class="hierarchy-badge">{{ configuredCount }} rule{{ configuredCount > 1 ? 's' : '' }}</span>
                {% endif %}
                <span class="accordion-meta">{{ entryTypes|length }} entry type{{ entryTypes|length > 1 ? 's' : '' }}</span>
            </div>
            <div class="accordion-body">
                {% if entryTypes|length < 2 %}
                    <p class="light">Needs at least 2 entry types to configure hierarchy.</p>
                {% else %}
                    <div style="display: flex; gap: 20px;">
                        <div style="flex: 2;">
                            <table class="data fullwidth" style="margin: 0;">
                                <thead>
                                    <tr>
                                        <th style="width: 24px;"></th>
                                        <th>Entry Type</th>
                                        <th>Level Selection</th>
                                    </tr>
                                </thead>
                                <tbody class="sortable-body">
                                    {% for type in orderedTypes %}
                                        {% set config = typeHierarchy[type.uid] ?? {} %}
                                        {% set prefix = "sectionConfig[#{section.uid}][typeHierarchy][#{type.uid}]" %}
                                        {% set parentUid = config.parentTypeUid ?? '' %}

                                        <tr class="sortable-row" data-type-uid="{{ type.uid }}" data-type-name="{{ type.name }}">
                                            <td class="drag-handle" style="cursor: move; text-align: center; color: #ccc;">⋮⋮</td>
                                            <td class="light">{{ type.name }}</td>
                                            <td>
                                                {{ forms.selectField({
                                                    name: "#{prefix}[parentTypeUid]",
                                                    options: [{label: 'Level 1', value: ''}]|merge(
                                                        entryTypes|filter(t => t.uid != type.uid)|map(t => {label: t.name, value: t.uid})
                                                    ),
                                                    value: parentUid,
                                                    small: true,
                                                    class: 'parent-select'
                                                }) }}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            <input type="hidden" name="sectionConfig[{{ section.uid }}][typeOrder]" class="type-order-input" value="{{ typeOrder|json_encode }}">
                        </div>
                        <div style="flex: 1; min-width: 180px;">
                            <div class="pane" style="background: #fafbfc; padding: 12px; margin: 0;">
                                <div style="font-weight: 600; font-size: 12px; color: #8f98a3; margin-bottom: 8px;">PREVIEW</div>
                                <div class="preview-tree" style="font-family: ui-monospace, monospace; font-size: 12px; line-height: 1.6;"></div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    {% endfor %}
{% endif %}

{% js %}
// Accordion toggle
document.querySelectorAll('.accordion-header').forEach(header => {
    header.onclick = () => header.parentElement.classList.toggle('open');
});

// Drag and drop
document.querySelectorAll('.sortable-body').forEach(tbody => {
    let dragged = null;
    tbody.querySelectorAll('.sortable-row').forEach(row => {
        row.draggable = true;
        row.ondragstart = () => { dragged = row; row.style.opacity = '0.4'; };
        row.ondragend = () => {
            row.style.opacity = '';
            dragged = null;
            updateOrder(tbody);
            updatePreview(tbody.closest('.section-config'));
        };
        row.ondragover = e => e.preventDefault();
        row.ondragenter = e => {
            if (!dragged || dragged === row) return;
            const mid = row.getBoundingClientRect().top + row.offsetHeight / 2;
            tbody.insertBefore(dragged, e.clientY < mid ? row : row.nextSibling);
        };
    });
});

function updateOrder(tbody) {
    const order = [...tbody.querySelectorAll('.sortable-row')].map(r => r.dataset.typeUid);
    tbody.closest('.section-config').querySelector('.type-order-input').value = JSON.stringify(order);
}

// Update preview on parent change
document.querySelectorAll('.parent-select select').forEach(s => {
    s.onchange = () => updatePreview(s.closest('.section-config'));
});

// Hierarchy preview
function updatePreview(section) {
    const preview = section.querySelector('.preview-tree');
    if (!preview) return;
    const types = {}, children = {};

    section.querySelectorAll('.sortable-row').forEach(row => {
        const uid = row.dataset.typeUid, name = row.dataset.typeName;
        const parentUid = row.querySelector('.parent-select select').value;
        types[uid] = { name, parentUid };
        (children[parentUid] = children[parentUid] || []).push(uid);
    });

    function tree(parentUid, depth = 0) {
        return (children[parentUid] || []).map(uid => {
            const indent = depth ? '<span style="color:#ccc">' + '│ '.repeat(depth-1) + '├ </span>' : '';
            return `<div>${indent}${types[uid].name}</div>` + tree(uid, depth + 1);
        }).join('');
    }

    preview.innerHTML = tree('') || '<span class="light">No hierarchy configured</span>';
}

document.querySelectorAll('.section-config').forEach(updatePreview);
{% endjs %}

